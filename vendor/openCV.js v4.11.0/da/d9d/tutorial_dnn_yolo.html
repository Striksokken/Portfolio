<!-- HTML header for doxygen 1.12.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OpenCV: YOLO DNNs</title>
<link rel="icon" href="../../opencv.ico" type="image/x-icon" />
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../tutorial-utils.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  },
  loader: {
    load: ['[tex]/ams']
  },
  tex: {
    macros: {},
    packages: ['base','configmacros','ams']
  }
};
//<![CDATA[
window.MathJax = {
    loader: {load: ['[tex]/ams']},
    tex: {
        packages: {'[+]': ['ams']},
        macros: {
            matTT: [ "\\[ \\left|\\begin{array}{ccc} #1 & #2 & #3\\\\ #4 & #5 & #6\\\\ #7 & #8 & #9 \\end{array}\\right| \\]", 9],
            fork: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ \\end{array} \\right.", 4],
            forkthree: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ #5 & \\mbox{#6}\\\\ \\end{array} \\right.", 6],
            forkfour: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ #5 & \\mbox{#6}\\\\ #7 & \\mbox{#8}\\\\ \\end{array} \\right.", 8],
            vecthree: ["\\begin{bmatrix} #1\\\\ #2\\\\ #3 \\end{bmatrix}", 3],
            vecthreethree: ["\\begin{bmatrix} #1 & #2 & #3\\\\ #4 & #5 & #6\\\\ #7 & #8 & #9 \\end{bmatrix}", 9],
            cameramatrix: ["#1 = \\begin{bmatrix} f_x & 0 & c_x\\\\ 0 & f_y & c_y\\\\ 0 & 0 & 1 \\end{bmatrix}", 1],
            distcoeffs: ["(k_1, k_2, p_1, p_2[, k_3[, k_4, k_5, k_6 [, s_1, s_2, s_3, s_4[, \\tau_x, \\tau_y]]]]) \\text{ of 4, 5, 8, 12 or 14 elements}"],
            distcoeffsfisheye: ["(k_1, k_2, k_3, k_4)"],
            hdotsfor: ["\\dots", 1],
            mathbbm: ["\\mathbb{#1}", 1],
            bordermatrix: ["\\matrix{#1}", 1]
        },
        processEscapes: false
    }
};
//]]>
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-chtml.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<!--#include virtual="/google-search.html"-->
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../opencv-logo-small.png"/></td>
  <td id="projectalign">
   <div id="projectname">OpenCV<span id="projectnumber">&#160;4.11.0</span>
   </div>
   <div id="projectbrief">Open Source Computer Vision</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../d9/df8/tutorial_root.html">OpenCV Tutorials</a></li><li class="navelem"><a class="el" href="../../d2/d58/tutorial_table_of_content_dnn.html">Deep Neural Networks (dnn module)</a></li>  </ul>
</div>
</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">YOLO DNNs</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1">
    <a href="#autotoc_md461">Running pre-trained YOLO model in OpenCV</a>
    <ul>
      <li class="level2">
        <a href="#autotoc_md462">YOLO&#39;s Pre-proccessing &amp; Output</a>
      </li>
      <li class="level2">
        <a href="#autotoc_md463">PyTorch Model Export</a>
        <ul>
          <li class="level3">
            <a href="#autotoc_md464">Exporting YOLOv10 model</a>
          </li>
        </ul>
      </li>
      <li class="level2">
        <a href="#autotoc_md465">Running Yolo ONNX detector with OpenCV Sample</a>
      </li>
      <li class="level2">
        <a href="#autotoc_md466">Building a Custom Pipeline</a>
      </li>
    </ul>
  </li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md__2build_24__x-contrib__docs-lin64_2opencv_2doc_2tutorials_2dnn_2dnn__yolo_2dnn__yolo"></a></p>
<p><b>Prev Tutorial:</b> <a class="el" href="../../dc/dfe/tutorial_dnn_openvino.html">OpenCV usage with OpenVINO</a> <br  />
<b>Next Tutorial:</b> <a class="el" href="../../d5/d86/tutorial_dnn_javascript.html">How to run deep networks in browser</a> <br  />
 </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadRight"></th><th class="markdownTableHeadLeft"></th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyRight">Original author   </td><td class="markdownTableBodyLeft">Alessandro de Oliveira Faria    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyRight">Extended by   </td><td class="markdownTableBodyLeft">Abduragim Shtanchaev    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyRight">Compatibility   </td><td class="markdownTableBodyLeft">OpenCV &gt;= 4.9.0   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md461"></a>
Running pre-trained YOLO model in OpenCV</h1>
<p>Deploying pre-trained models is a common task in machine learning, particularly when working with hardware that does not support certain frameworks like PyTorch. This guide provides a comprehensive overview of exporting pre-trained YOLO family models from PyTorch and deploying them using OpenCV's DNN framework. For demonstration purposes, we will focus on the <a href="https://github.com/Megvii-BaseDetection/YOLOX/blob/main" target="_blank">YOLOX</a> model, but the methodology applies to other supported models.</p>
<dl class="section note"><dt>Note</dt><dd>Currently, OpenCV supports the following YOLO models:<ul>
<li><a href="https://github.com/Megvii-BaseDetection/YOLOX/blob/main" target="_blank">YOLOX</a>,</li>
<li><a href="https://github.com/Deci-AI/super-gradients/tree/master" target="_blank">YOLONas</a>,</li>
<li><a href="https://github.com/THU-MIG/yolov10/tree/main" target="_blank">YOLOv10</a>,</li>
<li><a href="https://github.com/WongKinYiu/yolov9" target="_blank">YOLOv9</a>,</li>
<li><a href="https://github.com/ultralytics/ultralytics/tree/main" target="_blank">YOLOv8</a>,</li>
<li><a href="https://github.com/WongKinYiu/yolov7/tree/main" target="_blank">YOLOv7</a>,</li>
<li><a href="https://github.com/meituan/YOLOv6/blob/main" target="_blank">YOLOv6</a>,</li>
<li><a href="https://github.com/ultralytics/yolov5" target="_blank">YOLOv5</a>,</li>
<li><a href="https://github.com/Tianxiaomo/pytorch-YOLOv4" target="_blank">YOLOv4</a>.</li>
</ul>
</dd></dl>
<p>This support includes pre and post-processing routines specific to these models. While other older version of YOLO are also supported by OpenCV in Darknet format, they are out of the scope of this tutorial.</p>
<p>Assuming that we have successfully trained YOLOX model, the subsequent step involves exporting and running this model with OpenCV. There are several critical considerations to address before proceeding with this process. Let's delve into these aspects.</p>
<h2><a class="anchor" id="autotoc_md462"></a>
YOLO's Pre-proccessing &amp; Output</h2>
<p>Understanding the nature of inputs and outputs associated with YOLO family detectors is pivotal. These detectors, akin to most Deep Neural Networks (DNN), typically exhibit variation in input sizes contingent upon the model's scale.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Model Scale   </th><th class="markdownTableHeadNone">Input Size    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Small Models <sup><a href="https://github.com/Megvii-BaseDetection/YOLOX/tree/main#standard-models" target="_blank">1</a></sup>   </td><td class="markdownTableBodyNone">416x416    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Midsize Models <sup><a href="https://github.com/Megvii-BaseDetection/YOLOX/tree/main#standard-models" target="_blank">2</a></sup>   </td><td class="markdownTableBodyNone">640x640    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Large Models <sup><a href="https://github.com/meituan/YOLOv6/tree/main#benchmark" target="_blank">3</a></sup>   </td><td class="markdownTableBodyNone">1280x1280   </td></tr>
</table>
<p>This table provides a quick reference to understand the different input dimensions commonly used in various YOLO models inputs. These are standard input shapes. Make sure you use input size that you trained model with, if it is differed from from the size mentioned in the table.</p>
<p>The next critical element in the process involves understanding the specifics of image pre-processing for YOLO detectors. While the fundamental pre-processing approach remains consistent across the YOLO family, there are subtle yet crucial differences that must be accounted for to avoid any degradation in performance. Key among these are the <code>resize type</code> and the <code>padding value</code> applied post-resize. For instance, the <a href="https://github.com/Megvii-BaseDetection/YOLOX/blob/ac58e0a5e68e57454b7b9ac822aced493b553c53/yolox/data/data_augment.py#L142" target="_blank">YOLOX model</a> utilizes a <code>LetterBox</code> resize method and a padding value of <code>114.0</code>. It is imperative to ensure that these parameters, along with the normalization constants, are appropriately matched to the model being exported.</p>
<p>Regarding the model's output, it typically takes the form of a tensor with dimensions [BxNxC+5] or [BxNxC+4], where 'B' represents the batch size, 'N' denotes the number of anchors, and 'C' signifies the number of classes (for instance, 80 classes if the model is trained on the COCO dataset). The additional 5 in the former tensor structure corresponds to the objectness score (obj), confidence score (conf), and the bounding box coordinates (cx, cy, w, h). Notably, the YOLOv8 model's output is shaped as [BxNxC+4], where there is no explicit objectness score, and the object score is directly inferred from the class score. For the YOLOX model, specifically, it is also necessary to incorporate anchor points to rescale predictions back to the image domain. This step will be integrated into the ONNX graph, a process that we will detail further in the subsequent sections.</p>
<h2><a class="anchor" id="autotoc_md463"></a>
PyTorch Model Export</h2>
<p>Now that we know know the parameters of the pre-precessing we can go on and export the model from Pytorch to ONNX graph. Since in this tutorial we are using YOLOX as our sample model, lets use its export for demonstration purposes (the process is identical for the rest of the YOLO detectors except <code>YOLOv10</code> model, see details on how to export it later in the post). To exporting YOLOX we can just use <a href="https://github.com/Megvii-BaseDetection/YOLOX/blob/ac58e0a5e68e57454b7b9ac822aced493b553c53/tools/export_onnx.py" target="_blank">export script</a>. Particularly we need following commands:</p>
<div class="fragment"><div class="line">git clone https://github.com/Megvii-BaseDetection/YOLOX.git</div>
<div class="line">cd YOLOX</div>
<div class="line">wget https://github.com/Megvii-BaseDetection/YOLOX/releases/download/0.1.1rc0/yolox_s.pth # download pre-trained weights</div>
<div class="line">python3 -m tools.export_onnx --output-name yolox_s.onnx -n yolox-s -c yolox_s.pth --decode_in_inference</div>
</div><!-- fragment --><p><b>NOTE:</b> Here <code>--decode_in_inference</code> is to include anchor box creation in the ONNX graph itself. It sets <a href="https://github.com/Megvii-BaseDetection/YOLOX/blob/ac58e0a5e68e57454b7b9ac822aced493b553c53/yolox/models/yolo_head.py#L210C16-L210C39" target="_blank">this value</a> to <code>True</code>, which subsequently includes anchor generation function.</p>
<p>Below we demonstrated the minimal version of the export script (which could be used for models other than YOLOX) in case it is needed. However, usually each YOLO repository has predefined export script.</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> onnx</div>
<div class="line"><span class="keyword">import</span> torch</div>
<div class="line"><span class="keyword">from</span> onnxsim <span class="keyword">import</span> simplify</div>
<div class="line"> </div>
<div class="line"><span class="comment"># load the model state dict</span></div>
<div class="line">ckpt = torch.load(ckpt_file, map_location=<span class="stringliteral">&quot;cpu&quot;</span>)</div>
<div class="line">model.load_state_dict(ckpt)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># prepare dummy input</span></div>
<div class="line">dummy_input = torch.randn(args.batch_size, 3, exp.test_size[0], exp.test_size[1])</div>
<div class="line"> </div>
<div class="line"><span class="comment">#export the model</span></div>
<div class="line">torch.onnx._export(</div>
<div class="line">    model,</div>
<div class="line">    dummy_input,</div>
<div class="line">    <span class="stringliteral">&quot;yolox.onnx&quot;</span>,</div>
<div class="line">    input_names=[<span class="stringliteral">&quot;input&quot;</span>],</div>
<div class="line">    output_names=[<span class="stringliteral">&quot;output&quot;</span>],</div>
<div class="line">    dynamic_axes={<span class="stringliteral">&quot;input&quot;</span>: {0: <span class="stringliteral">&#39;batch&#39;</span>},</div>
<div class="line">                  <span class="stringliteral">&quot;output&quot;</span>: {0: <span class="stringliteral">&#39;batch&#39;</span>}})</div>
<div class="line"> </div>
<div class="line"><span class="comment"># use onnx-simplifier to reduce reduent model.</span></div>
<div class="line">onnx_model = onnx.load(args.output_name)</div>
<div class="line">model_simp, check = simplify(onnx_model)</div>
<div class="line"><span class="keyword">assert</span> check, <span class="stringliteral">&quot;Simplified ONNX model could not be validated&quot;</span></div>
<div class="line">onnx.save(model_simp, args.output_name)</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md464"></a>
Exporting YOLOv10 model</h3>
<p>In oder to run YOLOv10 one needs to cut off postporcessing with dynamic shapes from torch and then convert it to ONNX. If someone is looking for on how to cut off the postprocessing, there is this <a href="https://github.com/Abdurrahheem/yolov10/tree/ash/opencv-export" target="_blank">forked branch</a> from official YOLOv10. The forked branch cuts of the postprocessing by <a href="https://github.com/Abdurrahheem/yolov10/blob/4fdaafd912c8891642bfbe85751ea66ec20f05ad/ultralytics/nn/modules/head.py#L522" target="_blank">returning output</a> of the model before postprocessing procedure itself. To convert torch model to ONNX follow this proceduce.</p>
<div class="fragment"><div class="line">git clone git@github.com:Abdurrahheem/yolov10.git</div>
<div class="line">conda create -n yolov10 python=3.9</div>
<div class="line">conda activate yolov10</div>
<div class="line">pip install -r requirements.txt</div>
<div class="line">python export_opencv.py --model=&lt;model-name&gt; --imgsz=&lt;input-img-size&gt;</div>
</div><!-- fragment --><p>By default <code>--model="yolov10s"</code> and <code>--imgsz=(480,640)</code>. This will generate file <code>yolov10s.onnx</code>, which can be use for inference in OpenCV</p>
<h2><a class="anchor" id="autotoc_md465"></a>
Running Yolo ONNX detector with OpenCV Sample</h2>
<p>Once we have our ONNX graph of the model, we just simply can run with OpenCV's sample. To that we need to make sure:</p>
<ol type="1">
<li>OpenCV is build with -DBUILD_EXAMLES=ON flag.</li>
<li>Navigate to the OpenCV's <code>build</code> directory</li>
<li>Run the following command:</li>
</ol>
<div class="fragment"><div class="line">./bin/example_dnn_yolo_detector --input=&lt;path_to_your_input_file&gt; \</div>
<div class="line">                                --classes=&lt;path_to_class_names_file&gt; \</div>
<div class="line">                                --thr=&lt;confidence_threshold&gt; \</div>
<div class="line">                                --nms=&lt;non_maximum_suppression_threshold&gt; \</div>
<div class="line">                                --mean=&lt;mean_normalization_value&gt; \</div>
<div class="line">                                --scale=&lt;scale_factor&gt; \</div>
<div class="line">                                --yolo=&lt;yolo_model_version&gt; \</div>
<div class="line">                                --padvalue=&lt;padding_value&gt; \</div>
<div class="line">                                --paddingmode=&lt;padding_mode&gt; \</div>
<div class="line">                                --backend=&lt;computation_backend&gt; \</div>
<div class="line">                                --target=&lt;target_computation_device&gt; \</div>
<div class="line">                                --width=&lt;model_input_width&gt; \</div>
<div class="line">                                --height=&lt;model_input_height&gt; \</div>
</div><!-- fragment --><ul>
<li>&ndash;input: File path to your input image or video. If omitted, it will capture frames from a camera.</li>
<li>&ndash;classes: File path to a text file containing class names for object detection.</li>
<li>&ndash;thr: Confidence threshold for detection (e.g., 0.5).</li>
<li>&ndash;nms: Non-maximum suppression threshold (e.g., 0.4).</li>
<li>&ndash;mean: Mean normalization value (e.g., 0.0 for no mean normalization).</li>
<li>&ndash;scale: Scale factor for input normalization (e.g., 1.0, 1/255.0, etc).</li>
<li>&ndash;yolo: YOLO model version (e.g., YOLOv3, YOLOv4, etc.).</li>
<li>&ndash;padvalue: Padding value used in pre-processing (e.g., 114.0).</li>
<li>&ndash;paddingmode: Method for handling image resizing and padding. Options: 0 (resize without extra processing), 1 (crop after resize), 2 (resize with aspect ratio preservation).</li>
<li>&ndash;backend: Selection of computation backend (0 for automatic, 1 for Halide, 2 for OpenVINO, etc.).</li>
<li>&ndash;target: Selection of target computation device (0 for CPU, 1 for OpenCL, etc.).</li>
<li>&ndash;device: Camera device number (0 for default camera). If <code>--input</code> is not provided camera with index 0 will used by default.</li>
<li>&ndash;width: Model input width. Not to be confused with the image width. (e.g., 416, 480, 640, 1280, etc).</li>
<li>&ndash;height: Model input height. Not to be confused with the image height. (e.g., 416, 480, 640, 1280, etc).</li>
</ul>
<p>Here <code>mean</code>, <code>scale</code>, <code>padvalue</code>, <code>paddingmode</code> should exactly match those that we discussed in pre-processing section in order for the model to match result in PyTorch</p>
<p>To demonstrate how to run OpenCV YOLO samples without your own pretrained model, follow these instructions:</p>
<ol type="1">
<li>Ensure Python is installed on your platform.</li>
<li>Confirm that OpenCV is built with the <code>-DBUILD_EXAMPLES=ON</code> flag.</li>
</ol>
<p>Run the YOLOX detector(with default values):</p>
<div class="fragment"><div class="line">git clone https://github.com/opencv/opencv_extra.git</div>
<div class="line">cd opencv_extra/testdata/dnn</div>
<div class="line">python download_models.py yolox_s_inf_decoder</div>
<div class="line">cd ..</div>
<div class="line">export OPENCV_TEST_DATA_PATH=$(pwd)</div>
<div class="line">cd &lt;build directory of OpenCV&gt;</div>
<div class="line">./bin/example_dnn_yolo_detector</div>
</div><!-- fragment --><p>This will execute the YOLOX detector with your camera. For YOLOv8 (for instance), follow these additional steps:</p>
<div class="fragment"><div class="line">cd opencv_extra/testdata/dnn</div>
<div class="line">python download_models.py yolov8</div>
<div class="line">cd ..</div>
<div class="line">export OPENCV_TEST_DATA_PATH=$(pwd)</div>
<div class="line">cd &lt;build directory of OpenCV&gt;</div>
<div class="line"> </div>
<div class="line">./bin/example_dnn_yolo_detector --model=onnx/models/yolov8n.onnx --yolo=yolov8 --mean=0.0 --scale=0.003921568627 --paddingmode=2 --padvalue=144.0 --thr=0.5 --nms=0.4 --rgb=0</div>
</div><!-- fragment --><p>For YOLOv10, follow these steps:</p>
<div class="fragment"><div class="line">cd opencv_extra/testdata/dnn</div>
<div class="line">python download_models.py yolov10</div>
<div class="line">cd ..</div>
<div class="line">export OPENCV_TEST_DATA_PATH=$(pwd)</div>
<div class="line">cd &lt;build directory of OpenCV&gt;</div>
<div class="line"> </div>
<div class="line">./bin/example_dnn_yolo_detector --model=onnx/models/yolov10s.onnx --yolo=yolov10 --width=640 --height=480  --scale=0.003921568627 --padvalue=114</div>
</div><!-- fragment --><p>This will run <code>YOLOv10</code> detector on first camera found on your system. If you want to run it on a image/video file, you can use <code>--input</code> option to specify the path to the file.</p>
<p>VIDEO DEMO: </p><div align='center'><iframe title='Video' width='560' height='349' src='https://www.youtube.com/embed/NHtRlndE2cg?rel=0' frameborder='0' align='middle' allowfullscreen></iframe></div><h2><a class="anchor" id="autotoc_md466"></a>
Building a Custom Pipeline</h2>
<p>Sometimes there is a need to make some custom adjustments in the inference pipeline. With OpenCV DNN module this is also quite easy to achieve. Below we will outline the sample implementation details:</p>
<ul>
<li>Import required libraries</li>
</ul>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d9/d8c/dnn_8hpp.html">opencv2/dnn.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d1/d4f/imgproc_2include_2opencv2_2imgproc_8hpp.html">opencv2/imgproc.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d6/d87/imgcodecs_8hpp.html">opencv2/imgcodecs.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;iostream&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;common.hpp&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d4/dd5/highgui_8hpp.html">opencv2/highgui.hpp</a>&gt;</span></div>
</div><!-- fragment --><ul>
<li>Read ONNX graph and create neural network model:</li>
</ul>
<div class="fragment"><div class="line">    <a class="code hl_class" href="../../db/d30/classcv_1_1dnn_1_1Net.html">Net</a> net = <a class="code hl_function" href="../../d6/d0f/group__dnn.html#ga4823489a689bf4edfae7447eb807b067">readNet</a>(weightPath);</div>
<div class="line">    <span class="keywordtype">int</span> <a class="code hl_function" href="../../dc/d1c/group__gapi__std__backends.html#ga0ea1033f48e85753bcd35218f7384ea7">backend</a> = parser.get&lt;<span class="keywordtype">int</span>&gt;(<span class="stringliteral">&quot;backend&quot;</span>);</div>
<div class="line">    net.<a class="code hl_function" href="../../db/d30/classcv_1_1dnn_1_1Net.html#a7f767df11386d39374db49cd8df8f59e">setPreferableBackend</a>(backend);</div>
<div class="line">    net.<a class="code hl_function" href="../../db/d30/classcv_1_1dnn_1_1Net.html#a9dddbefbc7f3defbe3eeb5dc3d3483f4">setPreferableTarget</a>(parser.get&lt;<span class="keywordtype">int</span>&gt;(<span class="stringliteral">&quot;target&quot;</span>));</div>
</div><!-- fragment --><ul>
<li>Read image and pre-process it:</li>
</ul>
<div class="fragment"><div class="line">    <span class="keywordtype">float</span> paddingValue = parser.get&lt;<span class="keywordtype">float</span>&gt;(<span class="stringliteral">&quot;padvalue&quot;</span>);</div>
<div class="line">    <span class="keywordtype">bool</span> swapRB = parser.get&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;rgb&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> inpWidth = parser.get&lt;<span class="keywordtype">int</span>&gt;(<span class="stringliteral">&quot;width&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> inpHeight = parser.get&lt;<span class="keywordtype">int</span>&gt;(<span class="stringliteral">&quot;height&quot;</span>);</div>
<div class="line">    <a class="code hl_class" href="../../d1/da0/classcv_1_1Scalar__.html">Scalar</a> <a class="code hl_function" href="../../d6/d84/namespacecv_1_1quality_1_1quality__utils.html#ae55d1c89ff5761730174745401162743">scale</a> = parser.get&lt;<a class="code hl_class" href="../../d1/da0/classcv_1_1Scalar__.html">Scalar</a>&gt;(<span class="stringliteral">&quot;scale&quot;</span>);</div>
<div class="line">    <a class="code hl_class" href="../../d1/da0/classcv_1_1Scalar__.html">Scalar</a> <a class="code hl_function" href="../../d2/de8/group__core__array.html#ga191389f8a0e58180bb13a727782cd461">mean</a> = parser.get&lt;<a class="code hl_class" href="../../d1/da0/classcv_1_1Scalar__.html">Scalar</a>&gt;(<span class="stringliteral">&quot;mean&quot;</span>);</div>
<div class="line">    ImagePaddingMode paddingMode = <span class="keyword">static_cast&lt;</span>ImagePaddingMode<span class="keyword">&gt;</span>(parser.get&lt;<span class="keywordtype">int</span>&gt;(<span class="stringliteral">&quot;paddingmode&quot;</span>));</div>
</div><!-- fragment --> <div class="fragment"><div class="line">    <a class="code hl_class" href="../../d6/d50/classcv_1_1Size__.html">Size</a> <a class="code hl_function" href="../../df/d5b/namespacecv_1_1gapi_1_1streaming.html#abc5db6c129a4ea2177b3bfce576d9499">size</a>(inpWidth, inpHeight);</div>
<div class="line">    <a class="code hl_struct" href="../../d9/d3c/structcv_1_1dnn_1_1Image2BlobParams.html">Image2BlobParams</a> imgParams(</div>
<div class="line">        scale,</div>
<div class="line">        size,</div>
<div class="line">        mean,</div>
<div class="line">        swapRB,</div>
<div class="line">        <a class="code hl_define" href="../../d1/d1b/group__core__hal__interface.html#ga4a3def5d72b74bed31f5f8ab7676099c">CV_32F</a>,</div>
<div class="line">        DNN_LAYOUT_NCHW,</div>
<div class="line">        paddingMode,</div>
<div class="line">        paddingValue);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// rescale boxes back to original image</span></div>
<div class="line">    <a class="code hl_struct" href="../../d9/d3c/structcv_1_1dnn_1_1Image2BlobParams.html">Image2BlobParams</a> paramNet;</div>
<div class="line">            paramNet.<a class="code hl_variable" href="../../d9/d3c/structcv_1_1dnn_1_1Image2BlobParams.html#a73314b6aa9559ad6e76b51bb63339c74">scalefactor</a> = <a class="code hl_function" href="../../d6/d84/namespacecv_1_1quality_1_1quality__utils.html#ae55d1c89ff5761730174745401162743">scale</a>;</div>
<div class="line">            paramNet.<a class="code hl_variable" href="../../d9/d3c/structcv_1_1dnn_1_1Image2BlobParams.html#a5908824ca320636871f4c0aee7ea02dd">size</a> = <a class="code hl_function" href="../../df/d5b/namespacecv_1_1gapi_1_1streaming.html#abc5db6c129a4ea2177b3bfce576d9499">size</a>;</div>
<div class="line">            paramNet.<a class="code hl_variable" href="../../d9/d3c/structcv_1_1dnn_1_1Image2BlobParams.html#aac95508aef61f6181dd1910703cd9e34">mean</a> = <a class="code hl_function" href="../../d2/de8/group__core__array.html#ga191389f8a0e58180bb13a727782cd461">mean</a>;</div>
<div class="line">            paramNet.<a class="code hl_variable" href="../../d9/d3c/structcv_1_1dnn_1_1Image2BlobParams.html#aafa7c714aa0d1f1c2fec93ef70ac5fdc">swapRB</a> = swapRB;</div>
<div class="line">            paramNet.<a class="code hl_variable" href="../../d9/d3c/structcv_1_1dnn_1_1Image2BlobParams.html#afd0ec07f8e03b05accf4072da0108414">paddingmode</a> = paddingMode;</div>
</div><!-- fragment --> <div class="fragment"><div class="line">        inp = <a class="code hl_function" href="../../d6/d0f/group__dnn.html#gadc12e5f4a801fd3c1d802f4c8c5d311c">blobFromImageWithParams</a>(img, imgParams);</div>
</div><!-- fragment --><ul>
<li>Inference:</li>
</ul>
<div class="fragment"><div class="line">    std::vector&lt;Mat&gt; outs;</div>
<div class="line">    std::vector&lt;int&gt; keep_classIds;</div>
<div class="line">    std::vector&lt;float&gt; keep_confidences;</div>
<div class="line">    std::vector&lt;Rect2d&gt; keep_boxes;</div>
<div class="line">    std::vector&lt;Rect&gt; boxes;</div>
</div><!-- fragment --> <div class="fragment"><div class="line">        net.<a class="code hl_function" href="../../db/d30/classcv_1_1dnn_1_1Net.html#a5586b0bb38700bd7294133e81eea6219">setInput</a>(inp);</div>
<div class="line">        net.<a class="code hl_function" href="../../db/d30/classcv_1_1dnn_1_1Net.html#a98ed94cb6ef7063d3697259566da310b">forward</a>(outs, net.<a class="code hl_function" href="../../db/d30/classcv_1_1dnn_1_1Net.html#a9f699cf9710abd63339b5b8e1937f171">getUnconnectedOutLayersNames</a>());</div>
</div><!-- fragment --><ul>
<li>Post-Processing</li>
</ul>
<p>All post-processing steps are implemented in function <code>yoloPostProcess</code>. Please pay attention, that NMS step is not included into onnx graph. Sample uses OpenCV function for it.</p>
<div class="fragment"><div class="line">        yoloPostProcessing(</div>
<div class="line">            outs, keep_classIds, keep_confidences, keep_boxes,</div>
<div class="line">            confThreshold, nmsThreshold,</div>
<div class="line">            yolo_model,</div>
<div class="line">            nc);</div>
</div><!-- fragment --><ul>
<li>Draw predicted boxes</li>
</ul>
<div class="fragment"><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">auto</span> box : keep_boxes)</div>
<div class="line">        {</div>
<div class="line">            boxes.push_back(<a class="code hl_class" href="../../d2/d44/classcv_1_1Rect__.html">Rect</a>(<a class="code hl_function" href="../../db/de0/group__core__utils.html#ga1c4500a953c96901f87178f098c781af">cvFloor</a>(box.x), <a class="code hl_function" href="../../db/de0/group__core__utils.html#ga1c4500a953c96901f87178f098c781af">cvFloor</a>(box.y), <a class="code hl_function" href="../../db/de0/group__core__utils.html#ga1c4500a953c96901f87178f098c781af">cvFloor</a>(box.width - box.x), <a class="code hl_function" href="../../db/de0/group__core__utils.html#ga1c4500a953c96901f87178f098c781af">cvFloor</a>(box.height - box.y)));</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        paramNet.<a class="code hl_function" href="../../d9/d3c/structcv_1_1dnn_1_1Image2BlobParams.html#a822728804c0d35fc3b743644ee192f60">blobRectsToImageRects</a>(boxes, boxes, img.size());</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> idx = 0; idx &lt; boxes.size(); ++idx)</div>
<div class="line">        {</div>
<div class="line">            <a class="code hl_class" href="../../d2/d44/classcv_1_1Rect__.html">Rect</a> box = boxes[idx];</div>
<div class="line">            drawPrediction(keep_classIds[idx], keep_confidences[idx], box.<a class="code hl_variable" href="../../d2/d44/classcv_1_1Rect__.html#a2cadfdc3b4b7dbf8085622b27e044572">x</a>, box.<a class="code hl_variable" href="../../d2/d44/classcv_1_1Rect__.html#a6a4860e984df1752623b6ce2a8bde73a">y</a>,</div>
<div class="line">                    box.<a class="code hl_variable" href="../../d2/d44/classcv_1_1Rect__.html#a6c16a3bce912faa4fe5be42d7f1b53fe">width</a> + box.<a class="code hl_variable" href="../../d2/d44/classcv_1_1Rect__.html#a2cadfdc3b4b7dbf8085622b27e044572">x</a>, box.<a class="code hl_variable" href="../../d2/d44/classcv_1_1Rect__.html#a6fed06513cedd76652389e38c7b1222e">height</a> + box.<a class="code hl_variable" href="../../d2/d44/classcv_1_1Rect__.html#a6a4860e984df1752623b6ce2a8bde73a">y</a>, img);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> std::string kWinName = <span class="stringliteral">&quot;Yolo Object Detector&quot;</span>;</div>
<div class="line">        <a class="code hl_function" href="../../d7/dfc/group__highgui.html#ga5afdf8410934fd099df85c75b2e0888b">namedWindow</a>(kWinName, WINDOW_NORMAL);</div>
<div class="line">        <a class="code hl_function" href="../../d7/dfc/group__highgui.html#ga453d42fe4cb60e5723281a89973ee563">imshow</a>(kWinName, img);</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.12.0-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Jan 8 2025 16:06:34 for OpenCV by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
<script type="text/javascript">
//<![CDATA[
addTutorialsButtons();
//]]>
</script>
</body>
</html>
